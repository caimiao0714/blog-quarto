<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="蔡苗">
<meta name="dcterms.date" content="2022-10-04">

<title>蔡苗 | Miao Cai - 个体地址的空间绘图</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean"
}
</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<link rel="stylesheet" media="screen" href="https://fontlibrary.org//face/tex-gyre-adventor" type="text/css">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">蔡苗 | Miao Cai</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blogs.html">博客 | Blogs</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html">发表 | Publications</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">个体地址的空间绘图</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">spatial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>蔡苗 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 4, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">内容 | Contents</h2>
   
  <ul>
  <li><a href="#空间数据总述" id="toc-空间数据总述" class="nav-link active" data-scroll-target="#空间数据总述">空间数据总述</a>
  <ul class="collapse">
  <li><a href="#数据类型" id="toc-数据类型" class="nav-link" data-scroll-target="#数据类型">数据类型</a></li>
  <li><a href="#相关r包" id="toc-相关r包" class="nav-link" data-scroll-target="#相关r包">相关R包</a></li>
  <li><a href="#相关函数" id="toc-相关函数" class="nav-link" data-scroll-target="#相关函数">相关函数</a>
  <ul class="collapse">
  <li><a href="#读取数据" id="toc-读取数据" class="nav-link" data-scroll-target="#读取数据">读取数据</a></li>
  <li><a href="#数据绘图" id="toc-数据绘图" class="nav-link" data-scroll-target="#数据绘图">数据绘图</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#r语言实践" id="toc-r语言实践" class="nav-link" data-scroll-target="#r语言实践">R语言实践</a>
  <ul class="collapse">
  <li><a href="#加载环境" id="toc-加载环境" class="nav-link" data-scroll-target="#加载环境">加载环境</a></li>
  <li><a href="#矢量边界绘制" id="toc-矢量边界绘制" class="nav-link" data-scroll-target="#矢量边界绘制">矢量边界绘制</a>
  <ul class="collapse">
  <li><a href="#数据位置" id="toc-数据位置" class="nav-link" data-scroll-target="#数据位置">数据位置</a></li>
  <li><a href="#矢量数据读取" id="toc-矢量数据读取" class="nav-link" data-scroll-target="#矢量数据读取">矢量数据读取</a></li>
  <li><a href="#矢量数据清理" id="toc-矢量数据清理" class="nav-link" data-scroll-target="#矢量数据清理">矢量数据清理</a></li>
  <li><a href="#矢量边界绘制-1" id="toc-矢量边界绘制-1" class="nav-link" data-scroll-target="#矢量边界绘制-1">矢量边界绘制</a></li>
  <li><a href="#矢量投影" id="toc-矢量投影" class="nav-link" data-scroll-target="#矢量投影">矢量投影</a></li>
  </ul></li>
  <li><a href="#栅格数据绘制" id="toc-栅格数据绘制" class="nav-link" data-scroll-target="#栅格数据绘制">栅格数据绘制</a>
  <ul class="collapse">
  <li><a href="#数据读取" id="toc-数据读取" class="nav-link" data-scroll-target="#数据读取">数据读取</a></li>
  <li><a href="#栅格数据清理" id="toc-栅格数据清理" class="nav-link" data-scroll-target="#栅格数据清理">栅格数据清理</a></li>
  <li><a href="#栅格数据绘制-1" id="toc-栅格数据绘制-1" class="nav-link" data-scroll-target="#栅格数据绘制-1">栅格数据绘制</a></li>
  <li><a href="#栅格和矢量数据混合绘制" id="toc-栅格和矢量数据混合绘制" class="nav-link" data-scroll-target="#栅格和矢量数据混合绘制">栅格和矢量数据混合绘制</a></li>
  </ul></li>
  <li><a href="#矢量和栅格数据交互处理" id="toc-矢量和栅格数据交互处理" class="nav-link" data-scroll-target="#矢量和栅格数据交互处理">矢量和栅格数据交互处理</a>
  <ul class="collapse">
  <li><a href="#矢量-rightarrow-等面积格子" id="toc-矢量-rightarrow-等面积格子" class="nav-link" data-scroll-target="#矢量-rightarrow-等面积格子">矢量 <span class="math inline">\(\rightarrow\)</span> 等面积格子</a></li>
  <li><a href="#栅格-rightarrow-矢量" id="toc-栅格-rightarrow-矢量" class="nav-link" data-scroll-target="#栅格-rightarrow-矢量">栅格 <span class="math inline">\(\rightarrow\)</span> 矢量</a></li>
  <li><a href="#基于矢量边界选出栅格数据" id="toc-基于矢量边界选出栅格数据" class="nav-link" data-scroll-target="#基于矢量边界选出栅格数据">基于矢量边界选出栅格数据</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#病人地址数据绘图实战" id="toc-病人地址数据绘图实战" class="nav-link" data-scroll-target="#病人地址数据绘图实战">病人地址数据绘图实战</a>
  <ul class="collapse">
  <li><a href="#地址分布网格图" id="toc-地址分布网格图" class="nav-link" data-scroll-target="#地址分布网格图">地址分布网格图</a>
  <ul class="collapse">
  <li><a href="#转换为矢量点" id="toc-转换为矢量点" class="nav-link" data-scroll-target="#转换为矢量点">转换为矢量点</a></li>
  <li><a href="#筛选广州内的点" id="toc-筛选广州内的点" class="nav-link" data-scroll-target="#筛选广州内的点">筛选广州内的点</a></li>
  <li><a href="#创造广州市内的格子" id="toc-创造广州市内的格子" class="nav-link" data-scroll-target="#创造广州市内的格子">创造广州市内的格子</a></li>
  <li><a href="#计算格子内人数" id="toc-计算格子内人数" class="nav-link" data-scroll-target="#计算格子内人数">计算格子内人数</a></li>
  <li><a href="#准备绘图数据" id="toc-准备绘图数据" class="nav-link" data-scroll-target="#准备绘图数据">准备绘图数据</a></li>
  <li><a href="#绘图" id="toc-绘图" class="nav-link" data-scroll-target="#绘图">绘图</a></li>
  </ul></li>
  <li><a href="#地址分布点图" id="toc-地址分布点图" class="nav-link" data-scroll-target="#地址分布点图">地址分布点图</a>
  <ul class="collapse">
  <li><a href="#经纬度点计数" id="toc-经纬度点计数" class="nav-link" data-scroll-target="#经纬度点计数">经纬度点计数</a></li>
  <li><a href="#计数的经纬度转换成空间点" id="toc-计数的经纬度转换成空间点" class="nav-link" data-scroll-target="#计数的经纬度转换成空间点">计数的经纬度转换成空间点</a></li>
  <li><a href="#绘图-1" id="toc-绘图-1" class="nav-link" data-scroll-target="#绘图-1">绘图</a></li>
  </ul></li>
  <li><a href="#地址分布饼图" id="toc-地址分布饼图" class="nav-link" data-scroll-target="#地址分布饼图">地址分布饼图</a>
  <ul class="collapse">
  <li><a href="#数据整理" id="toc-数据整理" class="nav-link" data-scroll-target="#数据整理">数据整理</a></li>
  <li><a href="#绘图-2" id="toc-绘图-2" class="nav-link" data-scroll-target="#绘图-2">绘图</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#期刊发表展示" id="toc-期刊发表展示" class="nav-link" data-scroll-target="#期刊发表展示">期刊发表展示</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>在公共卫生的科研论文或标书撰写过程中，我们常常需要使用地址数据。此时，能用可视化的方式展示样本的空间分布往往能够给编辑或审稿人较好的印象分。</p>
<section id="空间数据总述" class="level1">
<h1>空间数据总述</h1>
<section id="数据类型" class="level2">
<h2 class="anchored" data-anchor-id="数据类型">数据类型</h2>
<ul>
<li>栅格数据（raster data）：一般是规整的相等面积的长方形格子。常见数据格式：<code>.tif</code>和<code>.nc</code>。</li>
<li>矢量数据（vector data）：点、线、多边形（polygons）。常见数据格式：<code>.shp</code>。</li>
</ul>
<p>下图展示了矢量数据和栅格数据的示意图</p>
<div class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-bottom">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="raster-data-example-noborder.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">栅格数据示例（广州市PM<span class="math inline">\(_{2.5}\)</span>浓度分布）</figcaption><p></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="vector-data-example.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">矢量数据示例（广州市区县边界）</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="相关r包" class="level2">
<h2 class="anchored" data-anchor-id="相关r包">相关R包</h2>
<ul>
<li>矢量数据：
<ul>
<li>新：<code>sf</code></li>
<li>旧：<code>sp</code></li>
</ul></li>
<li>栅格数据：
<ul>
<li>新：<code>stars</code></li>
<li>旧：<code>raster</code>, <code>terra</code></li>
</ul></li>
</ul>
</section>
<section id="相关函数" class="level2">
<h2 class="anchored" data-anchor-id="相关函数">相关函数</h2>
<section id="读取数据" class="level3">
<h3 class="anchored" data-anchor-id="读取数据">读取数据</h3>
<ul>
<li>矢量数据：<code>sf::read_sf()</code></li>
<li>栅格数据：
<ul>
<li>新：<code>stars::read_stars()</code></li>
<li>旧：<code>raster::raster()</code>, <code>terra</code></li>
</ul></li>
</ul>
</section>
<section id="数据绘图" class="level3">
<h3 class="anchored" data-anchor-id="数据绘图">数据绘图</h3>
<p>此处只介绍运用<code>ggplot2</code>图层语法进行绘图的函数</p>
<ul>
<li>矢量数据：<code>geom_sf()</code></li>
<li>栅格数据：<code>geom_stars()</code></li>
</ul>
</section>
</section>
</section>
<section id="r语言实践" class="level1">
<h1>R语言实践</h1>
<section id="加载环境" class="level2">
<h2 class="anchored" data-anchor-id="加载环境">加载环境</h2>
<p>首先需要加载R环境和相关的包。如果你使用的是课题组的Linux服务器，则下面三行均需要运行。如果你使用自己的电脑，或者你的R包环境已经配置好，可以忽略<code>pacman::p_load</code>下面的那两句。</p>
<div class="cell" data-run="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(raster, sf, stars, cubelyr, dplyr, ggplot2, viridis, here, ggspatial)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">rgl.useNULL =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">PROJ_LIB =</span> <span class="st">'/data1/Software/Installed/Anaconda3/envs/r4.1/share/proj'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="矢量边界绘制" class="level2">
<h2 class="anchored" data-anchor-id="矢量边界绘制">矢量边界绘制</h2>
<p>本节以中国的矢量图边界为例，展示用R的<code>sf</code>和<code>dplyr</code>包来处理矢量地图数据（<code>.shp</code>文件），然后用<code>ggplot2</code>来绘制矢量边界地图。由于全国的所有边界数据较大，绘制时间比较久，因此大部分时间本文采用广州市的区县边界进行展示。</p>
<section id="数据位置" class="level3">
<h3 class="anchored" data-anchor-id="数据位置">数据位置</h3>
<div class="cell" data-run="false">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>shp_path <span class="ot">=</span> <span class="st">'/data2/ShareData/MAP/China_shp'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>public_path <span class="ot">=</span> <span class="st">'/data1/Public'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>fs<span class="sc">::</span><span class="fu">dir_info</span>(shp_path) <span class="sc">%&gt;%</span> </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(path, size) <span class="sc">%&gt;%</span> </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">.shp'</span>, path))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  path                             size
  &lt;fs::path&gt;                &lt;fs::bytes&gt;
1 E:/China_shp/boundary.shp       1.01M
2 E:/China_shp/city.shp          26.35M
3 E:/China_shp/county.shp        57.66M
4 E:/China_shp/NineLine.shp       2.88M
5 E:/China_shp/province.shp      23.32M</code></pre>
</div>
</div>
<div class="cell">

</div>
<p>从上到下分别是：</p>
<ol type="1">
<li>中国国界（<code>boundary.shp</code>）</li>
<li>中国市级边界（<code>city.shp</code>）</li>
<li>中国区县级边界（<code>county.shp</code>）</li>
<li>九段线（<code>NineLine.shp</code>）</li>
<li>中国省级边界（<code>province.shp</code>）</li>
</ol>
</section>
<section id="矢量数据读取" class="level3">
<h3 class="anchored" data-anchor-id="矢量数据读取">矢量数据读取</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>CN_boundary <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="fu">here</span>(shp_path, <span class="st">'boundary.shp'</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>CN_city <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="fu">here</span>(shp_path, <span class="st">'city.shp'</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>CN_county <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="fu">here</span>(shp_path, <span class="st">'county.shp'</span>))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>CN_9dash <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="fu">here</span>(shp_path, <span class="st">'NineLine.shp'</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>CN_province <span class="ot">=</span> <span class="fu">read_sf</span>(<span class="fu">here</span>(shp_path, <span class="st">'province.shp'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="矢量数据清理" class="level3">
<h3 class="anchored" data-anchor-id="矢量数据清理">矢量数据清理</h3>
<p>这些矢量数据实际就像数据框，可以使用<code>dplyr</code>（<code>dplyr::select()</code>，<code>mutate()</code>, <code>filter()</code>, <code>arrange()</code>）的语法进行操作。例如，可以使用<code>filter()</code>选取广州市的区县边界：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 11 features and 7 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 815833.3 ymin: 2383964 xmax: 925069.2 ymax: 2537977
Projected CRS: Krasovsky_1940_Albers
# A tibble: 11 × 8
      PAC NAME   省代码 省     市代码 市     类型                       geometry
 *  &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;            &lt;MULTIPOLYGON [m]&gt;
 1 440103 荔湾区 440000 广东省 440100 广州市 市辖区 (((847866 2444953, 848089.6…
 2 440104 越秀区 440000 广东省 440100 广州市 市辖区 (((848782.7 2445425, 849481…
 3 440105 海珠区 440000 广东省 440100 广州市 市辖区 (((853312.2 2440874, 854128…
 4 440106 天河区 440000 广东省 440100 广州市 市辖区 (((863466.5 2455459, 863169…
 5 440111 白云区 440000 广东省 440100 广州市 市辖区 (((869239.4 2477347, 869252…
 6 440112 黄埔区 440000 广东省 440100 广州市 市辖区 (((871179.3 2476068, 871272…
 7 440113 番禺区 440000 广东省 440100 广州市 市辖区 (((876897.9 2433952, 876905…
 8 440114 花都区 440000 广东省 440100 广州市 市辖区 (((847130 2495872, 847622.5…
 9 440115 南沙区 440000 广东省 440100 广州市 市辖区 (((895851 2386042, 893897.1…
10 440117 从化区 440000 广东省 440100 广州市 市辖区 (((921473.7 2534710, 921480…
11 440118 增城区 440000 广东省 440100 广州市 市辖区 (((923442.3 2473232, 923443…</code></pre>
</div>
</div>
<p>类似地，也可以选取广州市各个区县的数据，如：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span> <span class="sc">&amp;</span> NAME <span class="sc">==</span> <span class="st">'越秀区'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1 feature and 7 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 847188.4 ymin: 2440527 xmax: 856131.5 ymax: 2447259
Projected CRS: Krasovsky_1940_Albers
# A tibble: 1 × 8
     PAC NAME   省代码 省     市代码 市     类型                        geometry
*  &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;             &lt;MULTIPOLYGON [m]&gt;
1 440104 越秀区 440000 广东省 440100 广州市 市辖区 (((848782.7 2445425, 849481.…</code></pre>
</div>
</div>
</section>
<section id="矢量边界绘制-1" class="level3">
<h3 class="anchored" data-anchor-id="矢量边界绘制-1">矢量边界绘制</h3>
<p>我们可以使用<code>ggplot2::geom_sf()</code>对广州市的区县边界进行绘制：</p>
<div class="grid" data-layout-valign="bottom">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>)) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="g-col-5">
<p><img src="gz-gray-fill.png" class="img-fluid"></p>
</div>
</div>
<p>如果你讨厌灰色的填充颜色，也可以通过<code>fill = NA</code>把颜色去掉：</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="g-col-5">
<p><img src="gz-no-fill.png" class="img-fluid"></p>
</div>
</div>
<p>我们可以通过<code>ggspatial::annotation_north_arrow()</code>和<code>ggspatial::annotation_north_arrow()</code>分别加上指北针和标尺。具体样式可以参考相关R文档进行修改。</p>
<div class="grid" data-layout-valign="bottom">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotation_scale</span>( <span class="co"># 标尺</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">width_hint =</span> <span class="fl">0.4</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">text_cex =</span> <span class="dv">1</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">unit_category =</span> <span class="st">'metric'</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> <span class="st">'bl'</span>) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotation_north_arrow</span>( <span class="co"># 指北针</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> <span class="st">"tl"</span>, </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">which_north =</span> <span class="st">"true"</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="fu">unit</span>(<span class="fl">0.7</span>, <span class="st">"cm"</span>),</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="fu">unit</span>(<span class="fl">0.7</span>, <span class="st">"cm"</span>),</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">pad_y =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"cm"</span>)) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="g-col-5">
<p><img src="gz-no-fill-noarrow.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="矢量投影" class="level3">
<h3 class="anchored" data-anchor-id="矢量投影">矢量投影</h3>
<p>WGS84是目前最流行的地理坐标系统。在国际上，每个坐标系统都会被分配一个EPSG 代码，<code>EPSG:4326</code>就是WGS84 的代码。GPS是基于WGS84的，所以通常我们得到的坐标数据都是WGS84的。一般我们在存储数据时，仍然按WGS84存储。计算地理距离时也应该通过WGS84投影进行计算。</p>
<p>但是如果绘图的时候使用WGS84投影，会显得靠近两极地区的面积失真。对于中国地图来说，WGS84投影非常不美观，画图来的地图像”一只强制性脊柱炎的公鸡”。因此，如果需要绘制全国地图，可以使用<code>ESPG: 4508</code>或者<code>ESPG: 32649</code>，在<code>ggplot2</code>中可以通过<code>coord_sf(crs = XXXX)</code>来设置整幅图的投影。</p>
<p>对于矢量数据，可以通过<code>sf::transform()</code>对其投影进行转换，如：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 原始数据投影为Asia_North_Albers_Equal_Area_Conic</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(CN_province)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -1492657 ymin: 2089131 xmax: 1056683 ymax: 4682373
Projected CRS: Asia_North_Albers_Equal_Area_Conic
# A tibble: 6 × 3
  CNAME  Name_E                                                         geometry
  &lt;chr&gt;  &lt;chr&gt;                                                &lt;MULTIPOLYGON [m]&gt;
1 安徽省 Anhui     (((578768.5 3711869, 578787.1 3711729, 578883.3 3711606, 578…
2 澳门   Macao     (((373363.8 2308123, 373702.6 2307267, 373759.7 2307131, 374…
3 北京市 Beijing   (((548491.6 4437692, 548534.5 4437621, 548562 4437591, 54859…
4 福建省 Fujian    (((759764.7 2483316, 759718.8 2483296, 759692.8 2483307, 759…
5 甘肃省 Gansu     (((-350146.9 3792524, -350199 3792482, -350290 3792537, -350…
6 广东省 Guangdong (((12072.27 2090275, 12129.04 2090236, 12168.24 2090234, 121…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 我们将其投影为WGS84</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>CN_province_4326 <span class="ot">=</span> <span class="fu">st_transform</span>(CN_province, <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(CN_province_4326)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 2 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 92.33783 ymin: 20.22318 xmax: 120.7244 ymax: 42.79458
Geodetic CRS:  WGS 84
# A tibble: 6 × 3
  CNAME  Name_E                                                         geometry
  &lt;chr&gt;  &lt;chr&gt;                                                &lt;MULTIPOLYGON [°]&gt;
1 安徽省 Anhui     (((116.4295 34.63088, 116.4296 34.62963, 116.4306 34.62848, …
2 澳门   Macao     (((113.5874 22.16486, 113.5904 22.15695, 113.5909 22.1557, 1…
3 北京市 Beijing   (((116.632 41.05889, 116.6325 41.05824, 116.6328 41.05795, 1…
4 福建省 Fujian    (((117.4155 23.56092, 117.415 23.56077, 117.4148 23.56089, 1…
5 甘肃省 Gansu     (((106.0713 35.44953, 106.0708 35.44915, 106.0697 35.4496, 1…
6 广东省 Guangdong (((110.1136 20.23365, 110.1142 20.23329, 110.1146 20.23328, …</code></pre>
</div>
</div>
<p>在使用<code>ggplot2</code>绘图过程中，也可以通过<code>coord_sf(crs = XXXX)</code>对投影进行转换。</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">ESPG: 4326</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">ESPG: 4508</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_province, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_9dash <span class="sc">%&gt;%</span> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(LEFT_FID <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'ESPG: 4326'</span>) <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ESPG-4326.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_province, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_9dash <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(LEFT_FID <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'ESPG: 4508'</span>) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="dv">4508</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ESPG-4508.png" class="img-fluid figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="栅格数据绘制" class="level2">
<h2 class="anchored" data-anchor-id="栅格数据绘制">栅格数据绘制</h2>
<section id="数据读取" class="level3">
<h3 class="anchored" data-anchor-id="数据读取">数据读取</h3>
<p>通过<code>stars::read_stars()</code>读取<code>.tif</code>文件得到的是<code>stars</code>数据类型，属于栅格数据类型。<code>stars</code>数据一般有三个维度（dimension）：<code>x</code>，<code>y</code>和<code>band</code>，其中<code>x</code>和<code>y</code>分别为经纬度，<code>band</code>则指时间维度，可将不同日期的数据整合到同一个<code>stars</code>对象中。除了维度之外，还包括一个属性（attribute），主要指数据变量，如空气污染和绿植覆盖。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pm_gz <span class="ot">=</span> <span class="fu">read_stars</span>(<span class="fu">here</span>(public_path, <span class="st">'CHAP_PM2.5_Guangzhou.tif'</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>pm_gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
                          Min. 1st Qu. Median     Mean 3rd Qu. Max. NA's
CHAP_PM2.5_Guangzhou.tif  20.5    21.9   22.8 22.77476    23.5 30.7 8557
dimension(s):
  from  to  offset delta refsys point values x/y
x    1 109 112.962  0.01 WGS 84 FALSE   NULL [x]
y    1 136 23.9297 -0.01 WGS 84 FALSE   NULL [y]</code></pre>
</div>
</div>
<p>此处的样例数据因为是单天的数据，因此只有两个维度（<code>x</code>和<code>y</code>），没有<code>band</code>的维度。数据的属性为<code>CHAP_PM2.5_Guangzhou</code>，并且报告了其简单的统计量（最小值、最大值、均值、缺失值数量以及四分位数）。每个维度都有一个名字（如<code>x</code>和<code>y</code>），每个维度的域的含义分别为：</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">域</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code>from</code></td>
<td>原点</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>to</code></td>
<td>终点的索引</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>offset</code></td>
<td>此维度起始点的值</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>delta</code></td>
<td>此维度网格的大小</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>refsys</code></td>
<td>投影系统</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code>point</code></td>
<td>逻辑值，<code>TRUE</code>代表点，<code>FALSE</code>代表区间</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code>values</code></td>
<td>此维度的值</td>
</tr>
</tbody>
</table>
<p>对于某个维度第i处的坐标为<code>offset + (i - 1)*delta</code>， 此值对应的是该栅格或区间的起始点。如果想得到该栅格或区间的中间点，则需额外加上0.5倍的<code>offset</code>。</p>
<p><code>stars</code>数据类型也可以通过<code>dplyr</code>包中的函数进行清理和转换。由于内容较多，此处不再详述，有兴趣的读者可以参考官方手册：</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/stars/vignettes/stars3.html">stars tidyverse methods</a></li>
</ul>
</section>
<section id="栅格数据清理" class="level3">
<h3 class="anchored" data-anchor-id="栅格数据清理">栅格数据清理</h3>
<p><code>stars</code>数据是<code>cubelyr</code>包中<code>tbl_cube</code>类型的一般化形式，我们可以通过<code>cubelyr::as.tbl_cube()</code>函数进行转换：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pm_gz_cube <span class="ot">=</span> <span class="fu">as.tbl_cube</span>(pm_gz)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>pm_gz_cube</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local array [14,824 x 2]
D: x [dbl, 109]
D: y [dbl, 136]
M: CHAP_PM2.5_Guangzhou.tif [dbl[,136]]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(pm_gz_cube)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ dims:List of 2
  ..$ x: num [1:109] 113 113 113 113 113 ...
  ..$ y: num [1:136] 23.9 23.9 23.9 23.9 23.9 ...
 $ mets:List of 1
  ..$ CHAP_PM2.5_Guangzhou.tif: num [1:109, 1:136] NA NA NA NA NA NA NA NA NA NA ...
 - attr(*, "class")= chr "tbl_cube"</code></pre>
</div>
</div>
<p>另外，我们也可以将其转换成<code>data.frame</code>以方便后续的操作，如双线性插值等。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pm_gz_tbl <span class="ot">=</span> <span class="fu">as_tibble</span>(pm_gz)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(pm_gz_tbl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [14,824 × 3] (S3: tbl_df/tbl/data.frame)
 $ x                       : num [1:14824] 113 113 113 113 113 ...
 $ y                       : num [1:14824] 23.9 23.9 23.9 23.9 23.9 ...
 $ CHAP_PM2.5_Guangzhou.tif: num [1:14824] NA NA NA NA NA NA NA NA NA NA ...</code></pre>
</div>
</div>
</section>
<section id="栅格数据绘制-1" class="level3">
<h3 class="anchored" data-anchor-id="栅格数据绘制-1">栅格数据绘制</h3>
<p>我们可以通过<code>ggplot2</code>中的<code>geom_stars()</code>对<code>stars</code>数据进行绘制。</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> pm_gz) <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">'white'</span>, </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">20</span><span class="sc">:</span><span class="dv">29</span>) <span class="sc">+</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'PM$_{2.5}$'</span>)) <span class="sc">+</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_coloursteps</span>( </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust =</span> <span class="dv">1</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.limits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="fu">unit</span>(<span class="fl">0.7</span>, <span class="st">"cm"</span>),</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight =</span> <span class="fu">unit</span>(<span class="dv">7</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="pm_stars.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="栅格和矢量数据混合绘制" class="level3">
<h3 class="anchored" data-anchor-id="栅格和矢量数据混合绘制">栅格和矢量数据混合绘制</h3>
<p>单纯的栅格数据比较单调，缺少行政边界信息。通过<code>ggplot2</code>的图层，我们可以轻松地加上矢量边界信息。</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> pm_gz) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>), <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">'white'</span>, </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="dv">20</span><span class="sc">:</span><span class="dv">29</span>) <span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'PM$_{2.5}$'</span>)) <span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_coloursteps</span>( </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust =</span> <span class="dv">1</span>,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.limits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="fu">unit</span>(<span class="fl">0.7</span>, <span class="st">"cm"</span>),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight =</span> <span class="fu">unit</span>(<span class="dv">7</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="pm_stars_gz-border.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="矢量和栅格数据交互处理" class="level2">
<h2 class="anchored" data-anchor-id="矢量和栅格数据交互处理">矢量和栅格数据交互处理</h2>
<section id="矢量-rightarrow-等面积格子" class="level3">
<h3 class="anchored" data-anchor-id="矢量-rightarrow-等面积格子">矢量 <span class="math inline">\(\rightarrow\)</span> 等面积格子</h3>
<p>我们可以通过<code>sf::st_make_grid()</code>函数将行政边界转换成相等大小的格子，类似栅格数据。</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>gz_rect <span class="ot">=</span> CN_city <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_make_grid</span>(<span class="at">cellsize =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.05</span>))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gz_rect, </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>), </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">'#08519c'</span>, </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="gz_rectangular.png" class="img-fluid"></p>
</div>
</div>
<p>上图中规整的正方形格子（矢量边界）为<code>sf::st_make_grid()</code>转换后的数据，蓝色填充的多边形为广州市区县边界。</p>
<p>需要注意的是，此时的格子<code>gz_rect</code>并非完美覆盖广州市的边界，而是能够环绕广州市边界的矩形，其面积大于广州市面积，包含不少不属于广州市的小格子（见图中）。我们可以用过<code>sf::st_intersection()</code>函数来保留只属于广州的小格子。</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>gz_grids <span class="ot">=</span> <span class="fu">st_intersection</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  gz_rect, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  CN_city <span class="sc">%&gt;%</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> gz_grids, </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="gz_grids-0.5.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="栅格-rightarrow-矢量" class="level3">
<h3 class="anchored" data-anchor-id="栅格-rightarrow-矢量">栅格 <span class="math inline">\(\rightarrow\)</span> 矢量</h3>
<p>由于广州市1km*1km的格子太多，不利于看清本文中天秀的操作，所以此小节中以中山大学南校区所在的海珠区为例进行展示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>haizhu_pm_2<span class="fl">.5</span> <span class="ot">=</span> <span class="fu">read_stars</span>(<span class="fu">here</span>(public_path, <span class="st">'Haizhu_Guangzhou_PM2.5.tif'</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>haizhu_pm_2<span class="fl">.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
                            Min. 1st Qu. Median     Mean 3rd Qu. Max. NA's
Haizhu_Guangzhou_PM2.5.tif  21.9    22.6   22.9 23.23671   23.85 25.8   73
dimension(s):
  from to  offset delta refsys point values x/y
x    1 19 113.232  0.01 WGS 84 FALSE   NULL [x]
y    1  8 23.1197 -0.01 WGS 84 FALSE   NULL [y]</code></pre>
</div>
</div>
<p>此处读入的数据<code>haizhu_pm_2.5</code>为<code>stars</code>格式的栅格数据，接下来我们可以通过<code>st_as_sf()</code>函数将<code>stars</code>数据转换成规整的矢量多边形（其实是正四边形）数据：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>pm_haizhu_sf <span class="ot">=</span> <span class="fu">st_as_sf</span>(haizhu_pm_2<span class="fl">.5</span>, <span class="at">as_points =</span> <span class="cn">FALSE</span>, <span class="at">merge =</span> <span class="cn">FALSE</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pm_haizhu_sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 113.2422 ymin: 23.0997 xmax: 113.2922 ymax: 23.1197
Geodetic CRS:  WGS 84
  Haizhu_Guangzhou_PM2.5.tif                       geometry
1                       24.6 POLYGON ((113.2622 23.1197,...
2                       25.2 POLYGON ((113.2422 23.1097,...
3                       25.8 POLYGON ((113.2522 23.1097,...
4                       24.7 POLYGON ((113.2622 23.1097,...
5                       24.0 POLYGON ((113.2722 23.1097,...
6                       23.7 POLYGON ((113.2822 23.1097,...</code></pre>
</div>
</div>
<p>我们可以通过绘图展示转换后的矢量多边形数据。此处我有意用<code>color = 'white'</code>加上栅格格子的边界，只用于提醒这里是规则格子的矢量多边形，而不是栅格数据。其实细心地读者可以发现这里用的是<code>geom_sf()</code>，因此绘图的对象为矢量多边形数据，而并非栅格数据（栅格数据应该用<code>geom_stars()</code>进行绘制）。海珠区的行政边界我用鲜艳的红色标出。</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> pm_haizhu_sf, </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">'#08519c'</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">'white'</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">'海珠区'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>),</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="haizhu_grids_border.png" class="img-fluid"></p>
</div>
</div>
<p>我们也可以在<code>geom_sf()</code>中设置<code>fill</code>的参数来绘制PM<span class="math inline">\(_{2.5}\)</span>，注意需要在<code>geom_sf()</code>的<code>aes</code>中设置。</p>
<ul>
<li>错误：<code>geom_sf(data = XX, fill = PM2.5)</code></li>
<li>正确：<code>geom_sf(data = XX, aes(fill = PM2.5))</code></li>
</ul>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pm_haizhu_sf, </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> Haizhu_Guangzhou_PM2.<span class="fl">5.</span>tif),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">'white'</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">'海珠区'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>),</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">'white'</span>,  <span class="at">breaks =</span> <span class="dv">20</span><span class="sc">:</span><span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'PM$_{2.5}$'</span>)) <span class="sc">+</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="haizhu_grids_border_fill.png" class="img-fluid"></p>
</div>
</div>
<p>我们也可以在<code>geom_sf()</code>中设置<code>color = NA</code>来去掉白色的边界。注意，由于不涉及任何数据框中的变量，因此不是在<code>aes()</code>中设置。</p>
<p>去掉白色的边界后图如下所示，生成的图与使用<code>geom_stars()</code>和栅格数据画出来的图像一模一样。</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pm_haizhu_sf, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> Haizhu_Guangzhou_PM2.<span class="fl">5.</span>tif),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">'海珠区'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>),</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">'red'</span>) <span class="sc">+</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">'white'</span>,  <span class="at">breaks =</span> <span class="dv">20</span><span class="sc">:</span><span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'PM$_{2.5}$'</span>)) <span class="sc">+</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="haizhu_grids_fill_nocolor.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="基于矢量边界选出栅格数据" class="level3">
<h3 class="anchored" data-anchor-id="基于矢量边界选出栅格数据">基于矢量边界选出栅格数据</h3>
<p>在上述海珠区的操作中，我们是直接读取已经与处理好的海珠区的PM<span class="math inline">\(_{2.5}\)</span>的栅格数据。此部分将展示如何基于矢量边界来裁剪栅格数据。</p>
<p>以广州为例，如果我们想选出中山大学公卫学院所在的越秀区的PM<span class="math inline">\(_{2.5}\)</span>浓度的栅格数据，我们需要首先选出越秀区的矢量行政边界：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>yuexiu_sf <span class="ot">=</span> CN_county <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">'越秀区'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然后我们可以使用<code>st_crop()</code>来对栅格数据进行裁剪。语法为<code>st_crop(x, y)</code>，其中<code>x</code>为栅格数据，<code>y</code>为矢量边界数据</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>yuexiu_pm2<span class="fl">.5</span> <span class="ot">=</span> <span class="fu">st_crop</span>(pm_gz, yuexiu_sf)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>yuexiu_pm2<span class="fl">.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s):
                          Min. 1st Qu. Median     Mean 3rd Qu. Max. NA's
CHAP_PM2.5_Guangzhou.tif  21.7   22.55     23 23.10323   23.75 24.9   41
dimension(s):
  from to  offset delta refsys point values x/y
x   28 36 112.962  0.01 WGS 84 FALSE   NULL [x]
y   76 83 23.9297 -0.01 WGS 84 FALSE   NULL [y]</code></pre>
</div>
</div>
<p>然后我们可将越秀区PM<span class="math inline">\(_{2.5}\)</span>浓度的栅格数据与矢量边界数据画出：</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_stars</span>(<span class="at">data =</span> yuexiu_pm2<span class="fl">.5</span>) <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> yuexiu_sf, <span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">'white'</span>, </span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">20</span>, <span class="dv">25</span>, <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">'PM$_{2.5}$'</span>),</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">'Yuexiu district'</span>) <span class="sc">+</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_coloursteps</span>(</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust =</span> <span class="dv">1</span>,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.limits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="fu">unit</span>(<span class="fl">0.7</span>, <span class="st">"cm"</span>),</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight =</span> <span class="fu">unit</span>(<span class="dv">7</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="yuexiu-pm2.5-border.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
</section>
<section id="病人地址数据绘图实战" class="level1">
<h1>病人地址数据绘图实战</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>gz_point_df <span class="ot">=</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="fu">here</span>(public_path, <span class="st">'Guangzhou_points.csv'</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>gz_point_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16,402 × 2
       X     Y
   &lt;dbl&gt; &lt;dbl&gt;
 1  113.  23.1
 2  113.  23.1
 3  114.  23.3
 4  113.  22.8
 5  113.  22.8
 6  113.  23.1
 7  113.  22.9
 8  113.  23.1
 9  113.  23.1
10  113.  23.1
# … with 16,392 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
<section id="地址分布网格图" class="level2">
<h2 class="anchored" data-anchor-id="地址分布网格图">地址分布网格图</h2>
<section id="转换为矢量点" class="level3">
<h3 class="anchored" data-anchor-id="转换为矢量点">转换为矢量点</h3>
<p>首先需要把经纬度的点转换成<code>sf</code>矢量点的数据，可以通过<code>sf::st_as_sf()</code>函数来实现</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>gz_point_sf <span class="ot">=</span> <span class="fu">st_as_sf</span>(gz_point_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>gz_point_sf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 16402 features and 0 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 109.2282 ymin: 20.26657 xmax: 115.7887 ymax: 26.07937
Geodetic CRS:  WGS 84
# A tibble: 16,402 × 1
              geometry
 *         &lt;POINT [°]&gt;
 1 (113.4126 23.11747)
 2 (113.4125 23.11745)
 3 (113.6053 23.28193)
 4 (113.4459 22.78224)
 5 (113.4459 22.78224)
 6 (113.3854 23.11756)
 7 (113.4597 22.92131)
 8 (113.4054 23.10063)
 9 (113.4054 23.10063)
10 (113.4054 23.10063)
# … with 16,392 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
</section>
<section id="筛选广州内的点" class="level3">
<h3 class="anchored" data-anchor-id="筛选广州内的点">筛选广州内的点</h3>
<p>然后需要需要筛选出落在广州市内部的点，可以通过<code>sf::st_filter(A, B)</code>来实现，其中<code>A</code>为矢量点数据，<code>B</code>是矢量多边形边界数据。特别需要注意的是，需要保证<code>A</code>和<code>B</code>的投影保持一致，基于前述关于经纬度的解释，建议保持<code>A</code>和<code>B</code>的投影均为<code>WGS84</code>，即<code>ESPG:4326</code>。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>gz_poly_sf <span class="ot">=</span> CN_city <span class="sc">%&gt;%</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>gz_point_sf_within <span class="ot">=</span> <span class="fu">st_filter</span>(</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  gz_point_sf, </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  gz_poly_sf)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>gz_point_sf_within</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 15446 features and 0 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 112.9677 ymin: 22.5888 xmax: 114.0157 ymax: 23.90779
Geodetic CRS:  WGS 84
# A tibble: 15,446 × 1
              geometry
 *         &lt;POINT [°]&gt;
 1 (113.4126 23.11747)
 2 (113.4125 23.11745)
 3 (113.6053 23.28193)
 4 (113.4459 22.78224)
 5 (113.4459 22.78224)
 6 (113.3854 23.11756)
 7 (113.4597 22.92131)
 8 (113.4054 23.10063)
 9 (113.4054 23.10063)
10 (113.4054 23.10063)
# … with 15,436 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
</section>
<section id="创造广州市内的格子" class="level3">
<h3 class="anchored" data-anchor-id="创造广州市内的格子">创造广州市内的格子</h3>
<p>如前述“矢量 <span class="math inline">\(\rightarrow\)</span> 等面积格子”中介绍过，我们可以通过<code>st_make_grid()</code>生成均匀的正方形格子，然后<code>st_intersection</code>裁剪广州市内的格子。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>gz_square_sf <span class="ot">=</span> gz_poly_sf <span class="sc">%&gt;%</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_make_grid</span>(<span class="at">cellsize =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.025</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(gz_poly_sf) <span class="sc">%&gt;%</span> </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>gz_square_sf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1164 features and 0 fields
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 112.9532 ymin: 22.5628 xmax: 114.0545 ymax: 23.93597
Geodetic CRS:  WGS 84
First 10 features:
                                x
1  MULTIPOLYGON (((113.6282 22...
2  MULTIPOLYGON (((113.6532 22...
3  POLYGON ((113.6563 22.58149...
4  POLYGON ((113.6944 22.5878,...
5  POLYGON ((113.5782 22.60264...
6  POLYGON ((113.6032 22.60223...
7  POLYGON ((113.6179 22.5878,...
8  MULTIPOLYGON (((113.6442 22...
9  MULTIPOLYGON (((113.6782 22...
10 POLYGON ((113.6884 22.6128,...</code></pre>
</div>
</div>
</section>
<section id="计算格子内人数" class="level3">
<h3 class="anchored" data-anchor-id="计算格子内人数">计算格子内人数</h3>
<p>可以通过<code>st_intersects()</code>来计算每个格子中的人数</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>gz_intersect <span class="ot">=</span> <span class="fu">st_intersects</span>(gz_square_sf, gz_point_sf_within) <span class="sc">%&gt;%</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lengths</span>()</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(gz_intersect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> int [1:1164] 0 0 0 0 0 0 3 2 1 0 ...</code></pre>
</div>
</div>
<p>此处<code>gz_intersect</code>的长度为1164，刚好是我们前面生成的广州市5*5格子（<code>gz_square_sf</code>）的数量。</p>
</section>
<section id="准备绘图数据" class="level3">
<h3 class="anchored" data-anchor-id="准备绘图数据">准备绘图数据</h3>
<p>我们可以通过<code>dplyr::mutate()</code>函数将这个计数变量加在<code>gz_square_sf</code>这个数据上，用于<code>ggplot2</code>的绘图。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>gz_square_sf_count <span class="ot">=</span> gz_square_sf <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">count =</span> gz_intersect)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>gz_square_sf_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1164 features and 1 field
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 112.9532 ymin: 22.5628 xmax: 114.0545 ymax: 23.93597
Geodetic CRS:  WGS 84
First 10 features:
                                x count
1  MULTIPOLYGON (((113.6282 22...     0
2  MULTIPOLYGON (((113.6532 22...     0
3  POLYGON ((113.6563 22.58149...     0
4  POLYGON ((113.6944 22.5878,...     0
5  POLYGON ((113.5782 22.60264...     0
6  POLYGON ((113.6032 22.60223...     0
7  POLYGON ((113.6179 22.5878,...     3
8  MULTIPOLYGON (((113.6442 22...     2
9  MULTIPOLYGON (((113.6782 22...     1
10 POLYGON ((113.6884 22.6128,...     0</code></pre>
</div>
</div>
</section>
<section id="绘图" class="level3">
<h3 class="anchored" data-anchor-id="绘图">绘图</h3>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gz_square_sf_count, </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">fill =</span> count), </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">'gray70'</span>, <span class="at">size =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_continuous</span>(</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"viridis"</span>, </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_colorsteps</span>(</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">'Count'</span>,</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust =</span> <span class="dv">1</span>,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.limits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight =</span> <span class="fu">unit</span>(<span class="dv">6</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">'count'</span>) <span class="sc">+</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="pat_gz_grids.png" class="img-fluid"></p>
</div>
</div>
<p>此处的颜色分布过于单一（个别格子的值过大），看不出太多的空间分布特征，我们可以通过对<code>count</code>变量进行排序进行初步验证：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>gz_square_sf_count <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>count) <span class="sc">%&gt;%</span> </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1164 features and 1 field
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: 112.9532 ymin: 22.5628 xmax: 114.0545 ymax: 23.93597
Geodetic CRS:  WGS 84
First 10 features:
   count                              x
1   4178 POLYGON ((113.8782 23.3878,...
2   1214 POLYGON ((113.4032 23.0878,...
3   1166 POLYGON ((113.4032 23.1128,...
4    507 POLYGON ((113.4282 23.0878,...
5    420 POLYGON ((113.3532 23.0878,...
6    312 POLYGON ((113.5532 23.1878,...
7    279 POLYGON ((113.3782 23.1128,...
8    210 POLYGON ((113.4032 23.0628,...
9    195 POLYGON ((113.3782 23.0878,...
10   151 POLYGON ((113.4532 23.5878,...</code></pre>
</div>
</div>
<p>我们可以通过<code>limits</code>和<code>oob</code>参数设定来修改配色范围，并且通过<code>breaks</code>和<code>labels</code>参数设定来修改图例，使得配色更好看，图例也更合理。代码及样图展示如下</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gz_square_sf_count, </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">fill =</span> count), </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">'gray70'</span>, <span class="at">size =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_continuous</span>(</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"viridis"</span>, </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, </span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120</span>), </span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">oob =</span> scales<span class="sc">::</span>squish,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120</span>, <span class="dv">20</span>), </span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="sc">~</span> <span class="fu">ifelse</span>(.x <span class="sc">&lt;</span> <span class="dv">120</span>, .x, <span class="st">'&gt;120'</span>),</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_colorsteps</span>(</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">'Count'</span>,</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust =</span> <span class="dv">1</span>,</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.limits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight =</span> <span class="fu">unit</span>(<span class="dv">6</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">'count'</span>) <span class="sc">+</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="pat_gz_grids_rescale.png" class="img-fluid"></p>
</div>
</div>
<p>也可以加上市和区县边界，可以显得更美观：</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gz_square_sf_count, </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">fill =</span> count), </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">'gray80'</span>, <span class="at">size =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">'gray40'</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_city <span class="sc">%&gt;%</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">'gray50'</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_continuous</span>(</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"viridis"</span>, </span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120</span>), </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">oob =</span> scales<span class="sc">::</span>squish,</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120</span>, <span class="dv">20</span>), </span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="sc">~</span> <span class="fu">ifelse</span>(.x <span class="sc">&lt;</span> <span class="dv">120</span>, .x, <span class="st">'&gt;120'</span>),</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_colorsteps</span>(</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">'Count'</span>,</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust =</span> <span class="dv">1</span>,</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.limits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight =</span> <span class="fu">unit</span>(<span class="dv">6</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">'count'</span>) <span class="sc">+</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="pat_gz_grids_rescale_border.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="地址分布点图" class="level2">
<h2 class="anchored" data-anchor-id="地址分布点图">地址分布点图</h2>
<p>使用分布点绘图的原理类似于地址分布网格图，但是其数据聚合方法是基于经纬度，而不是基于地理分布边界。数据点非常多的时候，用点图来展示地址分布一般更美观，因为其空间精度更高。</p>
<section id="经纬度点计数" class="level3">
<h3 class="anchored" data-anchor-id="经纬度点计数">经纬度点计数</h3>
<p>数据的预处理（转换成矢量点和筛选广州市内的点）步骤跟前述一致，此处不再重复叙述，我们直接从预处理好的数据<code>gz_point_sf_within</code>开始，可以通过<code>st_coordinates()</code>将<code>sf points</code>转换成包含经纬度坐标的数据框：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>gz_point_sf_within <span class="sc">%&gt;%</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         X        Y
1 113.4126 23.11747
2 113.4125 23.11745
3 113.6053 23.28193
4 113.4459 22.78224
5 113.4459 22.78224
6 113.3854 23.11756</code></pre>
</div>
</div>
<p>由于本数据的经纬度十分精细，对原始数据经纬度的计数过于精细，绘图时会重叠过多效果不佳。因此可将经纬度四舍五入到小数点后2位（大约为1km的精度），再对经纬度进行计数：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>gz_point_count <span class="ot">=</span> gz_point_sf_within <span class="sc">%&gt;%</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_coordinates</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">X =</span> <span class="fu">round</span>(X, <span class="dv">2</span>),</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">Y =</span> <span class="fu">round</span>(Y, <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(X, Y)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>gz_point_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,095 × 3
       X     Y     n
   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
 1  113.  23.4     1
 2  113.  23.4     3
 3  113.  23.4     2
 4  113.  23.4     8
 5  113.  23.3     8
 6  113.  23.4    15
 7  113.  23.4     1
 8  113.  23.3     3
 9  113.  23.3     1
10  113.  23.3     2
# … with 1,085 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
</section>
<section id="计数的经纬度转换成空间点" class="level3">
<h3 class="anchored" data-anchor-id="计数的经纬度转换成空间点">计数的经纬度转换成空间点</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>gz_point_count_sf <span class="ot">=</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    gz_point_count, </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">'X'</span>, <span class="st">'Y'</span>), </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(n)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>gz_point_count_sf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 1095 features and 1 field
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 112.97 ymin: 22.59 xmax: 114.02 ymax: 23.91
Geodetic CRS:  WGS 84
# A tibble: 1,095 × 2
       n       geometry
   &lt;int&gt;    &lt;POINT [°]&gt;
 1     1 (112.97 23.45)
 2     1 (113.04 23.41)
 3     1 (113.05 23.28)
 4     1 (113.05 23.31)
 5     1 (113.05 23.43)
 6     1 (113.05 23.46)
 7     1 (113.06 23.28)
 8     1 (113.06 23.37)
 9     1 (113.07 23.31)
10     1 (113.07 23.39)
# … with 1,085 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
</section>
<section id="绘图-1" class="level3">
<h3 class="anchored" data-anchor-id="绘图-1">绘图</h3>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">'gray40'</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gz_point_count_sf, </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">color =</span> n), <span class="at">shape =</span> <span class="dv">19</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_city <span class="sc">%&gt;%</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">'gray50'</span>, <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_continuous</span>(</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"viridis"</span>, </span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, </span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120</span>), </span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">oob =</span> scales<span class="sc">::</span>squish,</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120</span>, <span class="dv">20</span>), </span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="sc">~</span> <span class="fu">ifelse</span>(.x <span class="sc">&lt;</span> <span class="dv">120</span>, .x, <span class="st">'&gt;120'</span>),</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_colorsteps</span>(</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">'Count'</span>,</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust =</span> <span class="dv">1</span>,</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.limits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight =</span> <span class="fu">unit</span>(<span class="dv">6</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">'count'</span>) <span class="sc">+</span></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="pat_gz_point_1.png" class="img-fluid"></p>
</div>
</div>
<p>将广州市内的背景换成灰色</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">'gray80'</span>, <span class="at">color =</span> <span class="st">'gray40'</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gz_point_count_sf, </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">color =</span> n), <span class="at">shape =</span> <span class="dv">19</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_city <span class="sc">%&gt;%</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">'gray50'</span>, <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_continuous</span>(</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"viridis"</span>, </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, </span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120</span>), </span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">oob =</span> scales<span class="sc">::</span>squish,</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120</span>, <span class="dv">20</span>), </span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="sc">~</span> <span class="fu">ifelse</span>(.x <span class="sc">&lt;</span> <span class="dv">120</span>, .x, <span class="st">'&gt;120'</span>),</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_colorsteps</span>(</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">'Count'</span>,</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust =</span> <span class="dv">1</span>,</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.limits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight =</span> <span class="fu">unit</span>(<span class="dv">6</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">'count'</span>) <span class="sc">+</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="pat_gz_point_2.png" class="img-fluid"></p>
</div>
</div>
<p>我们也可以把整个背景都换成灰色，可以通过调整<code>theme()</code>中的<code>plot.background</code>参数进行改变。</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">'gray40'</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gz_point_count_sf, </span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">color =</span> n), <span class="at">shape =</span> <span class="dv">19</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_city <span class="sc">%&gt;%</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">'gray50'</span>, <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_continuous</span>(</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"viridis"</span>, </span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">'A'</span>, </span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, </span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120</span>), </span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">oob =</span> scales<span class="sc">::</span>squish,</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120</span>, <span class="dv">20</span>), </span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="sc">~</span> <span class="fu">ifelse</span>(.x <span class="sc">&lt;</span> <span class="dv">120</span>, .x, <span class="st">'&gt;120'</span>),</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="fu">guide_colorsteps</span>(</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">'Count'</span>,</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">title.hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.hjust =</span> <span class="dv">1</span>,</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.limits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">barwidth =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>),</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">barheight =</span> <span class="fu">unit</span>(<span class="dv">6</span>, <span class="st">"cm"</span>))) <span class="sc">+</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">'count'</span>) <span class="sc">+</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">"#d9d9d9"</span>, </span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="cn">NA</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="pat_gz_point_3.png" class="img-fluid"></p>
</div>
</div>
<p>点的形状可以是正方形、三角形、十字、叉、钻石等，可以通过<code>shape = XX</code>来进行指定，具体每个数字代表的图形可通过<a href="https://blog.albertkuo.me/post/point-shape-options-in-ggplot/">此博文</a>进行学习。</p>
</section>
</section>
<section id="地址分布饼图" class="level2">
<h2 class="anchored" data-anchor-id="地址分布饼图">地址分布饼图</h2>
<section id="数据整理" class="level3">
<h3 class="anchored" data-anchor-id="数据整理">数据整理</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>gz_pie <span class="ot">=</span> gz_point_count <span class="sc">%&gt;%</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>n) <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>gz_pie_sf <span class="ot">=</span> gz_pie <span class="sc">%&gt;%</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"X"</span>, <span class="st">"Y"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="绘图-2" class="level3">
<h3 class="anchored" data-anchor-id="绘图-2">绘图</h3>
<p>需要改变的只是<code>shape</code>。此处我们设置<code>shape = 21</code>，因为此形状既支持<code>fill</code>，又支持<code>color</code>，能够给予绘图更多的维度和灵活性。</p>
<div class="grid">
<div class="g-col-7">
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_county <span class="sc">%&gt;%</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">'gray40'</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gz_pie_sf, </span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">size =</span> n), </span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">'#f768a1'</span>, <span class="at">color =</span> <span class="st">'#7a0177'</span>, </span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CN_city <span class="sc">%&gt;%</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(市 <span class="sc">==</span> <span class="st">'广州市'</span>),</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">'gray50'</span>, <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">28</span>),</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">4000</span>),</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">'N'</span>) <span class="sc">+</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">'count'</span>) <span class="sc">+</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</div>
<div class="g-col-5">
<p><img src="pat_gz_pie_1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
</section>
<section id="期刊发表展示" class="level1">
<h1>期刊发表展示</h1>
<div class="grid">
<div class="g-col-5">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="STOTEN.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><strong>Cai, M.</strong>, et al.&nbsp;(2022) Ambient particulate matter pollution of different sizes associated with recurrent stroke hospitalization in China: a cohort study of 1.07 million stroke patients. <strong><em>Science of the Total Environment</em></strong>. 159104. DOI: <a href="https://doi.org/10.1016/j.scitotenv.2022.159104">10.1016/j.scitotenv.2022.159104</a></figcaption><p></p>
</figure>
</div>
</div>
<div class="g-col-7">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="CJASN.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Benjamin, B., <strong>Cai, M.</strong>, et al.&nbsp;(2021) Acute Kidney Injury in a National Cohort of Hospitalized United States Veterans with COVID-19. <strong><em>Clinical Journal of the American Society of Nephrology (CJASN)</em></strong> 16(1), 14-25. DOI: <a href="https://doi.org/10.2215/CJN.09610620">10.2215/CJN.09610620</a></figcaption><p></p>
</figure>
</div>
</div>
<div class="g-col-5">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Neurology.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><strong>Cai, M.</strong>, et al.&nbsp;(2022) Association of ambient particulate matter pollution of different sizes with in-hospital case fatality among stroke patients in China. <strong><em>Neurology.</em></strong> 98(4), e2474-e2486. DOI: <a href="https://doi.org/10.1212/WNL.0000000000200546">10.1212/WNL.0000000000200546</a></figcaption><p></p>
</figure>
</div>
</div>
<div class="g-col-7">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="IJPH.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><strong>Cai, M.</strong>, et al.&nbsp;(2022) “The Chasm in Percutaneous Coronary Intervention and In-hospital Mortality Rates among Acute Myocardial Infarction Patients in Rural and Urban Hospitals in China: A Mediation Analysis”, <strong><em>International Journal of Public Health</em></strong>. DOI: <a href="https://doi.org/10.3389/ijph.2022.1604846">10.3389/ijph.2022.1604846</a></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">

</div>
<div class="cell">

</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="quarto-dev/quarto-docs" data-repo-id="" data-category="General" data-category-id="" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, Miao Cai</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>